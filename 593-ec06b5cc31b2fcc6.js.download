"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[593],{20593:function(e,r,n){n.d(r,{Z:function(){return re}});var t={};n.r(t),n.d(t,{checkAndTrack:function(){return H},ensureTrackedFile:function(){return Y},storeOp:function(){return z}});var o=n(57135),i=n(72006),a=n(4405),l=n(9970),s=n(96583),c=n(4561),u=n(22011),f=n(87978),d=n(83344),h=n(12583),p=n(29118),v=n(70902),y=n(66091),m=n(5683),g=n(45347),w=n(72100),C=n(70090),E=n(51228),D=n(86763),k=n.n(D),b=n(70232);function F(e,r){var n=!0,t=!1,o=void 0;try{for(var i,a=r[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var l=i.value;switch(l){case c.Df.NotFound:if(e.includes("no such file"))return c.Df.NotFound;if(e.includes("file does not exist"))return c.Df.NotFound;break;case c.Df.AlreadyExists:if(e.includes("file exist"))return c.Df.AlreadyExists;break;case c.Df.NotDirectory:if(e.includes("not a directory"))return c.Df.NotDirectory;break;case c.Df.IsDirectory:if(e.includes("is a directory"))return c.Df.IsDirectory;break;case c.Df.InvalidPath:if(e.includes("absolute paths are not supported"))return c.Df.InvalidPath;break;case c.Df.DiskQuotaExceeded:if(e.includes("disk quota exceeded"))return c.Df.DiskQuotaExceeded;break;case c.Df.PermissionDenied:if(e.includes("permission denied"))return c.Df.PermissionDenied;break;default:(0,b.Z)(l)}}}catch(s){t=!0,o=s}finally{try{n||null==a.return||a.return()}finally{if(t)throw o}}return null}var S=n(68282),_=n(14806);var x=n(68241),T=n(9353),O=n(70065),Z=function(e){(0,m.Z)(n,e);var r=(0,g.Z)(n);function n(e,t,l,f,d,h){var m;(0,y.Z)(this,n),(m=r.call(this)).writeChanges=function(e,r){if(!m.channel&&!m.isReconnecting)throw new Error("Trying to send changes before ever coming online");m.isReconnecting&&(m.didEditOffline=!0);var n=(0,S.ed)(e,m.localContent),t=n.op,o=n.docAfter;if(Math.random()<.1){var a=(0,S.f5)(E.type.apply(m.localContent,t)),l=e.apply((0,S.tT)(m.localContent));a===l.sliceString(0)&&a===(0,S.f5)(o)||m.onError("changeset to op mismatch",{originalError:null,changes:e,otContent:a,changeSetContent:l,docAfter:o})}var s,c="ghostwriter"===(null===(s=r)||void 0===s?void 0:s.author)?{author:p.api.OTPacket.Author.GHOSTWRITER}:{};m.metadata=(0,i.Z)({},m.metadata,c);try{m.pending=E.type.compose(m.pending,t)}catch(u){throw O.Z.wrap(u).setExtras({op:t,pending:m.pending})}m.localContent=o,0!==m.pending.length?m.emit("fileDirty"):m.commitPromise&&m.emit("commitStart"),m.debounceSend()},m.updateCursors=function(e){m.pendingCursors=e,m.debounceSend()},m.isClean=function(){return m.committedVersion===m.version&&0===m.inflight.length&&0===m.pending.length},m.onError=function(e,r){if(r.originalError){var n="string"===typeof r.originalError?r.originalError:r.originalError.message,t=F(n,[c.Df.NotFound,c.Df.IsDirectory,c.Df.DiskQuotaExceeded,c.Df.InvalidPath,c.Df.PermissionDenied]);if(t)return void m.emit("fsError",t,n)}m.destroy();var o=new Error("OT Error: "+e);m.emit("error",o,(0,a.Z)((0,i.Z)({},r),{filePath:m.linkedFile,version:m.version}))},m.sendOp=function(){if(m.channel&&"open"===m.channel.status&&!m.isReconnecting&&!(m.inflight.length>0)){if(0!==m.pending.length){var e=(0,S.gR)(m.pending);m.inflight=m.pending,m.pending=[],m.inflightOpsPromise=m.channel.request({ot:(0,i.Z)({spookyVersion:m.version,op:e},m.metadata)}),m.metadata={},m.inflightOpsPromise.then((function(r){r.error&&m.onError("error accepting packet",{originalError:r.error,op:e})}))}if(0!==m.pendingCursors.length){var r=!0,n=!1,t=void 0;try{for(var o,a=m.flushedCursorIds[Symbol.iterator]();!(r=(o=a.next()).done);r=!0){var l=o.value;m.channel.send({otDeleteCursor:{id:l}})}}catch(v){n=!0,t=v}finally{try{r||null==a.return||a.return()}finally{if(n)throw t}}m.flushedCursorIds=[];var s=!0,c=!1,u=void 0;try{for(var f,d=m.pendingCursors[Symbol.iterator]();!(s=(f=d.next()).done);s=!0){var h=f.value,p=Number(Math.random().toString().split(".")[1]).toString(36);m.flushedCursorIds.push(p),m.channel.send({otNewCursor:(0,i.Z)({id:p,user:m.user},h)})}}catch(v){c=!0,u=v}finally{try{s||null==d.return||d.return()}finally{if(c)throw u}}m.pendingCursors=[]}}},m.handlePacket=function(e,r){var n=e.op,t=e.version,o=e.crc32,i=r.overrideReconnectingBuffer;if(!m.isReconnecting||i)if(-1!==m.version){if(m.version++,t!==m.version){var a={originalError:null,expectedVersion:m.version,receivedVersion:t,incomingOp:n};return m.logger.error("OT Error: invalid server version",(0,x.P1)({details:a})),void m.onError("invalid server version",a)}try{m.serverContent=E.type.apply(m.serverContent,n)}catch(y){return void m.onError("unable to apply updated content",{originalError:y,incomingOp:n})}var l=C.str(m.serverContent)>>>0;if(l!==o){var s={originalError:null,incomingVersion:t,server:o,client:l,incomingOp:n};return m.logger.error("OT Error: crc32 mismatch",(0,x.P1)({details:s})),void m.onError("crc32 mismatch",s)}if(m.uncommittedOps.push({version:t,crc32:o,op:n}),m.dataloss&&m.shouldTrackDataLoss&&m.dataloss.storeOp({replId:m.replId,filePath:m.linkedFile,opType:"latestOp",op:{version:t,crc32:o},logger:m.logger}),JSON.stringify(n)===JSON.stringify(m.inflight))return m.dataloss&&m.shouldTrackDataLoss&&m.dataloss.storeOp({replId:m.replId,filePath:m.linkedFile,opType:"latestOwnOp",op:{version:t,crc32:o},logger:m.logger}),m.debounceCommit(),m.inflight=[],m.inflightOpsPromise=null,m.debounceSend(),void m.debounceSend.flush();if(m.commitPromise||m.emit("fileDirty"),m.debounceCommit(),m.hasUncommittedMultiplayerOps=!0,m.inflight.length){var c=E.type.transform(m.inflight,n,"right");n=E.type.transform(n,m.inflight,"left"),m.inflight=c}if(m.pending.length){var u=E.type.transform(m.pending,n,"right");n=E.type.transform(n,m.pending,"left"),m.pending=u}var f=(0,S.mt)(n,m.localContent),d=f.changes,h=f.docAfter;if(Math.random()<.1){var p=(0,S.f5)(E.type.apply(m.localContent,n)),v=d.apply((0,S.tT)(m.localContent));p===v.sliceString(0)&&p===(0,S.f5)(h)||m.onError("op to changeset mismatch",{originalError:null,op:n,otContent:p,changeSetContent:v,docAfter:h})}m.localContent=h,m.emit("changes",d)}else m.onError("Got packet while version is still -1, expected version to be set in handleStatus",{originalError:null});else m.bufferedReconnectingOps.push({crc32:o,op:n,version:t})},m.handleNewCursor=function(e){m.emit("cursor",e)},m.handleDeleteCursor=function(e){var r=e.id;m.emit("removeCursor",r)};var g=(0,v.Z)(m);m.handleStatus=function(){var e=(0,o.Z)((function(e){var r,n,t,o,i;return(0,s.__generator)(this,(function(a){switch(a.label){case 0:return g.channel&&"open"===g.channel.status?e.linkedFile?null==e.contents?(g.onError("expected status contents, got null or undefined",{originalError:null}),[2]):null==e.cursors?(g.onError("expected status cursors, got null or undefined",{originalError:null}),[2]):null==e.version?(g.onError("expected status version, got null or undefined",{originalError:null}),[2]):g.isReconnecting?(g.handleReconnect(e.contents,e.version),[2]):(g.dataloss&&g.shouldTrackDataLoss&&g.dataloss.checkAndTrack({serverContent:e.contents,serverVersion:e.version,replId:g.replId,filePath:g.linkedFile,fetchOps:g.fetchOps,logger:g.logger}),g.serverContent=e.contents,g.localContent=g.serverContent,g.version=e.version,g.emit("firstConnect"),g.emit("changes",_.as.of({from:0,insert:g.serverContent},0)),e.cursors.forEach(g.handleNewCursor),g.emit("fileDirty"),g.debounceCommit(),[2]):[4,g.channel.request({otLinkFile:{file:{path:g.linkedFile}}})]:[2];case 1:return(n=a.sent()).channelClosed?[2]:n.error?(g.onError("link file error "+n.error.replace(g.linkedFile,"$FILENAME"),{originalError:n.error}),[2]):n.otLinkFileResponse?(t=n.otLinkFileResponse.version,i=u.Z.from(null!==(o=null===(r=n.otLinkFileResponse.linkedFile)||void 0===r?void 0:r.content)&&void 0!==o?o:"").toString(),g.isReconnecting?(g.handleReconnect(i,t),[2]):(g.dataloss&&g.shouldTrackDataLoss&&g.dataloss.checkAndTrack({serverContent:i,serverVersion:t,replId:g.replId,filePath:g.linkedFile,fetchOps:g.fetchOps,logger:g.logger}),g.serverContent=i,g.localContent=g.serverContent,g.version=t,g.committedVersion=t,g.committedContent=g.serverContent,g.emit("firstConnect"),g.emit("changes",_.as.of({from:0,insert:g.serverContent},0)),[2])):(g.onError("unexpected link file response: "+JSON.stringify(n.toJSON()),{originalError:null}),[2])}}))}));return function(r){return e.apply(this,arguments)}}();var w=(0,v.Z)(m);m.handleReconnect=function(){var e=(0,o.Z)((function(e,r){var n,t,o,l,c,u,f,d,h,p,v,y,m,g,C,D,k,b,F,S,_,O,Z,R,P,L,M,I,N,A,B,V,U,q,Q,W,j,$,J,K,Y,z,G,H,X,ee,re,ne,te,oe,ie;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!w.timeDisconnected)throw new Error("wat");if(n=Date.now()-w.timeDisconnected,t={case:"other",remoteContent:e,localContent:w.localContent},o=function(t){w.reconnectTrackedData=(0,a.Z)((0,i.Z)({},t),{serverVersion:r,ourVersion:w.version,ourCommittedVersion:w.committedVersion,areContentsEqual:w.serverContent===e,areCommittedContentsEqual:w.committedContent===e,didReceiveOpsWhileReconnecting:Boolean(w.bufferedReconnectingOps.length),didEditOffline:w.didEditOffline,hasPendingOps:Boolean(w.pending.length),disconnectDuration:n}),w.logger.info("OT Client: Reconnect",(0,x.P1)((0,i.Z)({},w.reconnectTrackedData))),w.track&&w.track(T.U3.FILE_RECONNECTED_STATUS2,w.reconnectTrackedData)},l=function(e,r){o({case:e,originCase:r,prompted:!1}),w.isReconnecting=!1,w.bufferedReconnectingOps=[],w.didEditOffline=!1,w.timeDisconnected=null,w.debounceSend(),w.debounceCommit(),w.emit("transparentReconnect",{case:e,originCase:r})},c=function(n){if(t.remoteContent===t.localContent)return w.version=r,w.committedVersion=r,w.localContent=e,w.committedContent=e,w.serverContent=e,w.inflight=[],w.pending=[],void l("unprompted_because_identical",n);o({case:n,prompted:!0}),t.case=n,w.emit("promptUserReconnect",t)},w.inflight.length){if(r===w.version&&w.serverContent===e)return w.pending=E.type.compose(w.inflight,w.pending),w.inflight=[],w.inflightOpsPromise=null,l("has_inflight_happy_path_ops_unreached"),[2];u=!1,f=w.serverContent;try{f=E.type.apply(f,w.inflight)}catch(ae){u=!0}return u||w.version+1!==r||f!==e?(c("has_inflight"),[2]):(c("has_inflight_happy_path_ops_reached"),[2])}if(w.hasUncommittedMultiplayerOps)return c("multiplayer"),[2];if(w.version===r)return e===w.serverContent?(l("happy_path"),[2]):(c("same_version_different_content"),[2]);if(w.committedVersion===r){d=e;try{h=!0,p=!1,v=void 0;try{for(y=w.uncommittedOps[Symbol.iterator]();!(h=(m=y.next()).done);h=!0)g=m.value.op,d=E.type.apply(d,g)}catch(le){p=!0,v=le}finally{try{h||null==y.return||y.return()}finally{if(p)throw v}}}catch(se){return c("same_committed_version_unable_to_apply_ops"),[2]}if(d===w.serverContent){C=[],D=!0,k=!1,b=void 0;try{for(F=w.uncommittedOps[Symbol.iterator]();!(D=(S=F.next()).done);D=!0)_=S.value.op,C=E.type.compose(C,_)}catch(le){k=!0,b=le}finally{try{D||null==F.return||F.return()}finally{if(k)throw b}}return w.pending=E.type.compose(C,w.pending),w.uncommittedOps=[],w.version=r,w.serverContent=e,l("happy_path_uncommitted"),[2]}return c("same_committed_version_different_content_fixed"),[2]}return w.version<r?[4,w.fetchOps(w.version+1,r)]:[3,3];case 1:O=s.sent(),Z=!1,R=w.serverContent;try{P=!0,L=!1,M=void 0;try{for(I=O[Symbol.iterator]();!(P=(N=I.next()).done);P=!0)A=N.value.op,R=E.type.apply(R,A)}catch(le){L=!0,M=le}finally{try{P||null==I.return||I.return()}finally{if(L)throw M}}}catch(ce){Z=!0}if(!Z&&R===e){B=!0,V=!1,U=void 0;try{for(q=O[Symbol.iterator]();!(B=(Q=q.next()).done);B=!0)W=Q.value,w.handlePacket(W,{overrideReconnectingBuffer:!0})}catch(le){V=!0,U=le}finally{try{B||null==q.return||q.return()}finally{if(V)throw U}}j=!0,$=!1,J=void 0;try{for(K=w.bufferedReconnectingOps[Symbol.iterator]();!(j=(Y=K.next()).done);j=!0)z=Y.value,w.handlePacket(z,{overrideReconnectingBuffer:!0})}catch(le){$=!0,J=le}finally{try{j||null==K.return||K.return()}finally{if($)throw J}}return l("happy_path_server_ahead"),[2]}return[4,w.fetchOps(w.committedVersion+1,r)];case 2:G=s.sent(),H=!1,X=w.committedContent;try{ee=!0,re=!1,ne=void 0;try{for(te=G[Symbol.iterator]();!(ee=(oe=te.next()).done);ee=!0)ie=oe.value.op,X=E.type.apply(X,ie)}catch(le){re=!0,ne=le}finally{try{ee||null==te.return||te.return()}finally{if(re)throw ne}}}catch(ue){H=!0}return H||X!==e?(c("uncommitted_server_ahead"),[2]):(c("happy_path_uncommitted_server_ahead"),[2]);case 3:return c("other"),[2]}}))}));return function(r,n){return e.apply(this,arguments)}}();var D=(0,v.Z)(m);m.flush=function(){var e=(0,o.Z)((function(e){return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return[4,D.commitPromise];case 1:return r.sent(),D.debounceCommit(e),D.debounceCommit.flush(),[4,D.commitPromise];case 2:return r.sent(),[2]}}))}));return function(r){return e.apply(this,arguments)}}();var b=(0,v.Z)(m);m.fetchOps=function(){var e=(0,o.Z)((function(e,r){var n;return(0,s.__generator)(this,(function(t){switch(t.label){case 0:if(!b.channel)throw new Error("No channel, cannot fetchOps");return[4,b.channel.request({otFetchRequest:{versionFrom:e,versionTo:r}})];case 1:if((n=t.sent()).channelClosed)throw new Error("Channel closed while requesting");if(n.error)throw new Error("Fetch ops returned an error: "+n.error);if(!n.otFetchResponse)throw new Error("Expected otFetchResponse");if(!n.otFetchResponse.packets)throw new Error("Expected otFetchResponse.packets");return[2,n.otFetchResponse.packets.map((function(e){var r=e.crc32,n=e.op,t=e.version,o=e.userId,i=e.committed,a=e.author;if(null==r)throw new Error("Expected crc32 in packet");if(null==n)throw new Error("Expected op in packet");if(null==t)throw new Error("Expected version in packet");return{crc32:r,version:t,op:(0,S.ug)(n),userId:o,timestamp:i?1e3*i.seconds:0,author:a}}))]}}))}));return function(r,n){return e.apply(this,arguments)}}();var Z=(0,v.Z)(m);m.fetchChanges=function(){var e=(0,o.Z)((function(e,r,n){var t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,Z.fetchOps(e,r)];case 1:return t=i.sent(),o=n,[2,t.map((function(e){var r=e.op,n=e.version,t=e.userId,i=e.timestamp,a=e.crc32,l=(0,S.mt)(r,o),s=l.changes,c=l.docAfter,u=s.invert((0,S.tT)(o));return o=c,{changes:s,invertedChanges:u,userId:t,version:n,timestamp:i,crc32:a}}))]}}))}));return function(r,n,t){return e.apply(this,arguments)}}();var R=(0,v.Z)(m);m.transformSelection=function(){var e=(0,o.Z)((function(e){var r,n,t,o,i,a,l,c;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(r=e.indexStart,n=e.indexEnd,t=e.versionFrom,o=e.versionTo,!R.channel)throw new Error("No channel, cannot transformSelection");return[4,R.channel.request({otTransformSelectionRequest:{indexStart:r,indexEnd:n,versionFrom:t,versionTo:o}})];case 1:if(!(i=s.sent()).otTransformSelectionResponse)throw new Error("Expected otTransformSelectionResponse");return[2,{indexStart:null!==(a=i.otTransformSelectionResponse.indexStart)&&void 0!==a?a:0,indexEnd:null!==(l=i.otTransformSelectionResponse.indexEnd)&&void 0!==l?l:0,version:null!==(c=i.otTransformSelectionResponse.version)&&void 0!==c?c:0}]}}))}));return function(r){return e.apply(this,arguments)}}(),m.getLocalContent=function(){return(0,S.f5)(m.localContent)},m.getRawLocalContent=function(){return m.localContent},m.shouldTrackDataLoss=!1,m.replId="",m.linkedFile=e,m.channel=null,m.inflight=[],m.inflightOpsPromise=null,m.uncommittedOps=[],m.hasUncommittedMultiplayerOps=!1,m.committedVersion=-1,m.isReconnecting=!1,m.bufferedReconnectingOps=[],m.didEditOffline=!1,m.pending=[],m.metadata={},m.version=-1,m.serverContent="",m.localContent="",m.committedContent="",m.flushedCursorIds=[],m.pendingCursors=[],m.user=null,m.flushFailed=0,m.debounceSend=k()((function(){return m.sendOp()}),20,{maxWait:60}),m.debounceCommit=k()((function(e){return m.commitToDisk(e)}),1e3,{maxWait:3e3}),m.commitPromise=null,m.timeDisconnected=null;var P=!1;return m.destroy=function(){P=!0},m.logger=f,m.track=h,m.dataloss=d,l.then((function(){P||(m.destroy=t.openChannel({service:"ot",name:"ot:".concat(e)},(function(r){var n=r.channel,t=r.context;return m.shouldTrackDataLoss=!window.navigator.userAgent.includes("Firefox"),m.replId=t.repl.id,m.dataloss&&m.shouldTrackDataLoss&&m.dataloss.ensureTrackedFile({replId:m.replId,filePath:e}),m.user=t.currentUser?{name:t.currentUser.username,id:t.currentUser.id}:null,m.channel=n,n.onCommand((function(e){switch(e.body){case"ot":var r,n,t;if(!e.ot||null==e.ot.op||null==e.ot.spookyVersion||null==e.ot.crc32)return void m.onError("missing data in ot packet",{originalError:null,op:null===(r=e.ot)||void 0===r?void 0:r.op,spookyVersion:null===(n=e.ot)||void 0===n?void 0:n.spookyVersion,crc32:null===(t=e.ot)||void 0===t?void 0:t.crc32});if(-1===m.version)return;var o={crc32:e.ot.crc32,op:(0,S.ug)(e.ot.op),version:e.ot.spookyVersion};return m.handlePacket(o,{overrideReconnectingBuffer:!1});case"otstatus":return m.handleStatus(e.otstatus);case"error":if(e.ref)return;return m.onError("Unknown protocol error OT channel",{originalError:e.error||"no error"});case"otNewCursor":return m.handleNewCursor(e.otNewCursor);case"otDeleteCursor":return m.handleDeleteCursor(e.otDeleteCursor)}})),function(){m.channel=null,m.isReconnecting=!0,m.debounceSend.cancel(),m.debounceCommit.cancel(),m.timeDisconnected||(m.timeDisconnected=Date.now())}})))})),m}return n.prototype.commitToDisk=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this;return(0,o.Z)((function(){var n,t,o,i,a,l;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!r.channel)throw new Error("Tryna commit while offline");if("open"!==r.channel.status)return[2];if(r.isReconnecting)throw new Error("Committing while reconnecting");return r.isClean()?[2]:r.commitPromise?(r.debounceCommit(e),[2]):(n=function(){},r.commitPromise=new Promise((function(e){return n=e})),r.inflightOpsPromise?[4,r.inflightOpsPromise]:[3,2]);case 1:if(s.sent().channelClosed)return r.commitPromise=null,n(),[2];s.label=2;case 2:return r.pending.length>0?(r.debounceSend(),r.debounceSend.flush(),r.inflightOpsPromise?[4,r.inflightOpsPromise]:(r.commitPromise=null,n(),r.onError("expected inflight promise",{originalError:null}),[2])):[3,4];case 3:if(s.sent().channelClosed)return r.commitPromise=null,n(),[2];s.label=4;case 4:return r.emit("commitStart"),t=r.version,o=r.serverContent,[4,r.channel.request({flush:e})];case 5:return(i=s.sent()).channelClosed?(r.flushFailed=0,r.commitPromise=null,n(),[2]):"ok"!==i.body?(r.commitPromise=null,n(),a=i.error||i.toString(),F(a,[c.Df.NotFound,c.Df.AlreadyExists,c.Df.NotDirectory,c.Df.IsDirectory,c.Df.DiskQuotaExceeded])?(r.onError("unable to flush",{originalError:a}),[2]):(r.flushFailed++,setTimeout((function(){r.isReconnecting||r.channel&&"open"===r.channel.status&&r.debounceCommit(e)}),Math.min(Math.random()*(Math.pow(2,r.flushFailed)-1)*1e3,1e3*Math.pow(2,10))),[2])):(r.dataloss&&r.shouldTrackDataLoss&&(l=r.uncommittedOps[r.uncommittedOps.length-1])&&r.dataloss.storeOp({replId:r.replId,filePath:r.linkedFile,op:{crc32:l.crc32,version:l.version},opType:"latestFlushedOp",logger:r.logger}),r.uncommittedOps=[],r.hasUncommittedMultiplayerOps=!1,r.committedVersion=t,r.committedContent=o,r.flushFailed=0,r.emit("commitComplete",t),r.isClean()&&r.emit("fileClean"),r.commitPromise=null,n(),[2,i])}}))}))()},n}(w.EventEmitter),R=Z,P=n(20575),L=n(91926),M=n(88254),I=n(12290),N=n(61871),A=n(8082);var B=n(53989);function V(e){var r,n=e.container,t=e.dataloss,v=e.track,y=e.channelRequestPriority,m=function(e){H.push(e),z(),e.then((function(){var r=H.indexOf(e);r>-1&&H.splice(r,1),K()}))},g=function(e){var r=!0,n=!1,t=void 0;try{for(var o,i=U[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){(0,o.value)(e)}}catch(a){n=!0,t=a}finally{try{r||null==i.return||i.return()}finally{if(n)throw t}}},w=function(e){var r=new R(e,n,Promise.all((0,l.Z)(H).map((function(e){return e.catch((function(){}))}))).then((function(){})),n.logger,t,v);return r.on("commitComplete",K),r.on("fileDirty",z),r.on("fileClean",z),r.on("commitStart",z),r},E=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4,r=function(r){for(var n=arguments.length,o=new Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];if(t.length>=e)throw new Error("fs: We retried too many things during a closed channel.");return new Promise((function(e){t.push(e)})).then((function(){return r.apply(void 0,(0,l.Z)(o))}))},n=function(){t.splice(0,t.length).forEach((function(e){return e()}))},t=[];return{enqueue:r,flush:n}}(),D=E.enqueue,k=E.flush,b=null,S=null,x=null,T=0,O=new Map,Z=new Map,V=new Map,U=[];n.openChannel({service:"fsevents",priority:y},(function(e){var r=e.channel;b=r,r.onCommand((function(e){if("fileEvent"===e.body){if(!e.fileEvent)throw new Error("Expected fileEvent");var r=e.fileEvent,n=r.file,t=r.dest,o=r.op;if(n){var i=n.path;if(null!==i&&null!==o&&void 0!==i&&void 0!==o){var a;if(K(),O.get(i)||n.type===p.api.File.Type.DIRECTORY)a=c.Tv.Directory;else{var l,s=Array.from(O.keys()).find((function(e){return(0,d.pC)(e,i)})),u=s&&(null===(l=O.get(s))||void 0===l?void 0:l.children.find((function(e){return e.filename===(0,f.UO)(i)})));a=u?u.type:c.Tv.File}switch(o){case p.api.FileEvent.Op.Create:re({eventType:c.kS.Create,node:{path:i,type:a}});break;case p.api.FileEvent.Op.Modify:if(a===c.Tv.Directory)break;re({eventType:c.kS.Modify,node:{path:i,type:a}});break;case p.api.FileEvent.Op.Remove:re({eventType:c.kS.Delete,node:{path:i,type:a}});break;case p.api.FileEvent.Op.Move:if(null==t||null==t.path)throw new Error("Expected dest path");var h=t.path;re({eventType:c.kS.Move,node:{path:i,type:a},to:h})}}}}}));var n=(0,l.Z)(new Set((0,l.Z)(O.keys()).concat((0,l.Z)(Z.keys()),(0,l.Z)(V.keys()))));return n.length&&r.send({subscribeFile:{files:n.map((function(e){return{path:e}}))}}),function(){b=null}}));var q=new Promise((function(e){return r=e}));n.openChannel({priority:y,service:function(e){return e.repl.currentUserPermissions.containerWrite?"gcsfiles":"files"}},(function(e){var n=e.channel;r(n),k();var t=(0,l.Z)(O.keys()).sort(),o=!0,i=!1,a=void 0;try{for(var s,u=function(){var e=s.value;oe.readDir(e).then((function(r){var n=O.get(e);if(n)if(r.error)re({eventType:c.kS.Delete,node:{path:e,type:c.Tv.Directory}});else{var t=r.children,o=n.children,i=o.filter((function(e){return!t.some((function(r){return r.filename===e.filename&&r.type===e.type}))})),a=!0,l=!1,s=void 0;try{for(var u,f=i[Symbol.iterator]();!(a=(u=f.next()).done);a=!0){var d=u.value;re({eventType:c.kS.Delete,node:{path:e===h.Ql?d.filename:e+"/"+d.filename,type:d.type}})}}catch(E){l=!0,s=E}finally{try{a||null==f.return||f.return()}finally{if(l)throw s}}var p=t.filter((function(e){return!o.some((function(r){return r.filename===e.filename&&r.type===e.type}))})),v=!0,y=!1,m=void 0;try{for(var g,w=p[Symbol.iterator]();!(v=(g=w.next()).done);v=!0){var C=g.value;re({eventType:c.kS.Create,node:{path:e===h.Ql?C.filename:e+"/"+C.filename,type:C.type}})}}catch(E){y=!0,m=E}finally{try{v||null==w.return||w.return()}finally{if(y)throw m}}}}))},f=t[Symbol.iterator]();!(o=(s=f.next()).done);o=!0)u()}catch(w){i=!0,a=w}finally{try{o||null==f.return||f.return()}finally{if(i)throw a}}var d=!0,p=!1,v=void 0;try{for(var y,m=function(){var e=y.value;oe.readFile(e,{fromDisk:!0}).then((function(r){var n=V.get(e);n&&(r.error?re({eventType:c.kS.Delete,node:{path:e,type:c.Tv.File}}):r.content.toBuffer().equals(n.latestContent.toBuffer())||re({eventType:c.kS.Modify,node:{path:e,type:c.Tv.File}}))}))},g=V.keys()[Symbol.iterator]();!(d=(y=g.next()).done);d=!0)m()}catch(w){p=!0,v=w}finally{try{d||null==g.return||g.return()}finally{if(p)throw v}}return function(){q=new Promise((function(e){return r=e}))}}));var Q=(0,N.Z)();Q.promise.catch((function(e){return e}));var W=(0,I.Z)((0,o.Z)((function(){var e;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return[4,Q.promise];case 1:return[4,r.sent().request({fsSnapshot:{}})];case 2:return(e=r.sent()).channelClosed?[2,{success:!1,error:"channel closed"}]:e.error?[2,{success:!1,error:e.error}]:[2,{error:null,success:!0}]}}))})),{wait:5e3,maxWait:1e4});n.openChannel({service:"snapshot",skip:function(e){return!e.repl.currentUserPermissions.containerWrite}},(function(e){var r=e.channel;return Q.resolve(r),function(){Q.isFulfilled&&(Q=(0,N.Z)()).promise.catch((function(e){return e}))}}));var j=c.kO.Clean,$=[],J=0;function K(){return Y.apply(this,arguments)}function Y(){return(Y=(0,o.Z)((function(){var e;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return J++,z(),[4,oe.persist()];case 1:return(e=r.sent()).error&&B.kg.error("Failed to persist, something very bad has probably happened",{originalError:e.error}),J--,z(),[2]}}))}))).apply(this,arguments)}function z(){return G.apply(this,arguments)}function G(){return(G=(0,o.Z)((function(){var e,r;return(0,s.__generator)(this,(function(n){return e=0===J&&0===H.length&&Array.from(Z.values()).every((function(e){return e.otClient.isClean()})),r=j===c.kO.Clean,e===r||(j=e?c.kO.Clean:c.kO.Syncing,$.forEach((function(e){e(j)}))),[2]}))}))).apply(this,arguments)}var H=[];function X(e,r){return ee.apply(this,arguments)}function ee(){return ee=(0,o.Z)((function(e,r){var n,t;return(0,s.__generator)(this,(function(i){return n=function(){var r=(0,o.Z)((function(){var r,t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,q];case 1:if("open"!==(r=i.sent()).status)return[2,D(n)];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,r.request(e)];case 3:return t=i.sent(),[3,5];case 4:return o=i.sent(),M.Tb(new Error("Send request failed with error: ".concat(o))),[2,D(n)];case 5:return t.channelClosed?[2,D(n)]:[2,t]}}))}));return function(){return r.apply(this,arguments)}}(),t=n(),r.isMutative&&m(t),[2,t]}))})),ee.apply(this,arguments)}function re(e){x=null;var r=e.node.path.includes("/")?(0,f.Il)(e.node.path):h.Ql,n=O.get(r),t=(0,f.UO)(e.node.path);if(!t)throw new Error("Expected filename");var o=null;if(e.eventType===c.kS.Move){var s=e.to.includes("/")?(0,f.Il)(e.to):h.Ql;o=O.get(s)}if(n||o)switch(e.eventType){case c.kS.Create:if(!n)break;var u=(0,l.Z)(n.children.filter((function(e){return e.filename!==t}))).concat([{type:e.node.type,filename:t}]),p=!0,v=!1,y=void 0;try{for(var m,g=n.listeners[Symbol.iterator]();!(p=(m=g.next()).done);p=!0){(0,m.value.onChange)(u)}}catch(De){v=!0,y=De}finally{try{p||null==g.return||g.return()}finally{if(v)throw y}}n.children=u;break;case c.kS.Move:var w=(0,f.UO)(e.to);if(n&&n===o){var C=(0,l.Z)(n.children.filter((function(e){return e.filename!==t&&e.filename!==w}))).concat([{type:e.node.type,filename:w}]),E=!0,D=!1,k=void 0;try{for(var b,F=n.listeners[Symbol.iterator]();!(E=(b=F.next()).done);E=!0){(0,b.value.onChange)(C)}}catch(De){D=!0,k=De}finally{try{E||null==F.return||F.return()}finally{if(D)throw k}}n.children=C;break}if(n){var S=n.children.filter((function(e){return e.filename!==t})),_=!0,T=!1,R=void 0;try{for(var P,L=n.listeners[Symbol.iterator]();!(_=(P=L.next()).done);_=!0){(0,P.value.onChange)(S)}}catch(De){T=!0,R=De}finally{try{_||null==L.return||L.return()}finally{if(T)throw R}}n.children=S}if(o){var I=(0,l.Z)(o.children.filter((function(e){return e.filename!==t&&e.filename!==w}))).concat([{type:e.node.type,filename:w}]),N=!0,A=!1,B=void 0;try{for(var U,q=o.listeners[Symbol.iterator]();!(N=(U=q.next()).done);N=!0){(0,U.value.onChange)(I)}}catch(De){A=!0,B=De}finally{try{N||null==q.return||q.return()}finally{if(A)throw B}}o.children=I}break;case c.kS.Delete:if(!n)break;var Q=n.children.filter((function(e){return e.filename!==t})),W=!0,j=!1,$=void 0;try{for(var J,K=n.listeners[Symbol.iterator]();!(W=(J=K.next()).done);W=!0){(0,J.value.onChange)(Q)}}catch(De){j=!0,$=De}finally{try{W||null==K.return||K.return()}finally{if(j)throw $}}n.children=Q;break;case c.kS.Modify:break;default:throw new Error("unknown event")}switch(e.eventType){case c.kS.Move:case c.kS.Delete:var Y=[Z.get(e.node.path),V.get(e.node.path),O.get(e.node.path)],z=!0,G=!1,H=void 0;try{for(var X,ee=Y[Symbol.iterator]();!(z=(X=ee.next()).done);z=!0){var ne=X.value;if(ne){var te=!0,ie=!1,ae=void 0;try{for(var le,se=ne.listeners[Symbol.iterator]();!(te=(le=se.next()).done);te=!0){var ce=le.value,ue=ce.onMoveOrDelete,fe=ce.dispose;ue&&ue(e),fe()}}catch(De){ie=!0,ae=De}finally{try{te||null==se.return||se.return()}finally{if(ie)throw ae}}}}}catch(De){G=!0,H=De}finally{try{z||null==ee.return||ee.return()}finally{if(G)throw H}}if(e.node.type===c.Tv.File)break;var de=(0,l.Z)(new Set((0,l.Z)(O.keys()).concat((0,l.Z)(V.keys()),(0,l.Z)(Z.keys())))).map((function(e){var r=Z.get(e)||V.get(e)||O.get(e);if(!r)throw new Error("expected node");return r})),he=[],pe=!0,ve=!1,ye=void 0;try{for(var me,ge=de.sort()[Symbol.iterator]();!(pe=(me=ge.next()).done);pe=!0){var we=me.value;if((0,d.yr)(e.node.path,we.path)){var Ce=he.slice(-1)[0];if(!Ce||!(0,d.yr)(Ce,we.path)){var Ee={eventType:c.kS.Delete,node:{path:we.path,type:we.type}};e.eventType===c.kS.Move&&(Ee=(0,a.Z)((0,i.Z)({},Ee),{eventType:c.kS.Move,to:(0,d.hk)(e.node.path,e.to,we.path)})),he.push(we.path),re(Ee)}}}}catch(De){ve=!0,ye=De}finally{try{pe||null==ge.return||ge.return()}finally{if(ve)throw ye}}break;case c.kS.Create:case c.kS.Modify:if(!V.has(e.node.path))break;oe.readFile(e.node.path,{fromDisk:!0}).then((function(r){var n=V.get(e.node.path);if(n)if(r.error)re({eventType:c.kS.Delete,node:{path:e.node.path,type:c.Tv.File}});else{n.latestContent=r.content;var t=!0,o=!1,i=void 0;try{for(var a,l=n.listeners[Symbol.iterator]();!(t=(a=l.next()).done);t=!0){var s=a.value.onChange;s&&s(r.content)}}catch(De){o=!0,i=De}finally{try{t||null==l.return||l.return()}finally{if(o)throw i}}}})).catch((function(e){e.message="File read after modify error: "+e.message,M.Tb(e)}))}}function ne(){return ne=(0,o.Z)((function(){var e,r,t,o,i,a,c,u,f;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!(o=null===(r=n.getContext())||void 0===r||null===(t=r.repl)||void 0===t?void 0:t.language))throw new Error("Expected repl language");return[4,(e=n).exec.apply(e,["ag","--noaffinity","-g *","--hidden"].concat((0,l.Z)(P.h.map((function(e){return"--ignore=".concat(e)})))))];case 1:return i=s.sent(),a=i.output,c=i.error,u=function(e){return!!e&&(!(0,P.C)(e)&&!L.ZP.isLangFileBinary(o,e))},!c&&a?[2,x={error:null,files:a.split("\n").filter(u)}]:c&&c.includes("not found")?[4,n.exec("find",".","-type","f","-print0")]:[3,3];case 2:if((f=s.sent()).output)return[2,x={error:null,files:f.output.slice(2,-1).split("\0./").filter(u)}];s.label=3;case 3:return"exit status 1"!==c&&M.Tb(new Error("Find file command failed with error: ".concat(c))),[2,{error:c,files:null}]}}))})),ne.apply(this,arguments)}var te=function(){var e=(0,o.Z)((function(e,r,n){var t,i,a,l,u,f,d,h;function p(e){return v.apply(this,arguments)}function v(){return(v=(0,o.Z)((function(e){var r;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.request(e)];case 1:if((r=n.sent()).channelClosed)throw new Error("channelClosed");if(r.error)throw new Error(r.error);return[2,r]}}))}))).apply(this,arguments)}return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return[4,q];case 1:t=o.sent(),i={eventType:c.kS.Create,node:{path:e,type:c.Tv.File}},o.label=2;case 2:return o.trys.push([2,9,,10]),[4,p({transferStart:{path:e,size:r.length}})];case 3:if(!(a=o.sent().transfer))throw new Error("Failed to start a transfer (no transfer id)");l=r.toBuffer(),u=512e3,n(l.length,0),f=0,o.label=4;case 4:return f<Math.ceil(r.length/u)?[4,p({transferChunk:{id:a.id,content:l.subarray(f*u,(f+1)*u)}})]:[3,7];case 5:o.sent(),n(l.length,Math.min(l.length,(f+1)*u)),o.label=6;case 6:return f++,[3,4];case 7:return[4,p({transferComplete:{id:a.id,crc32:C.buf(l)}})];case 8:return o.sent(),[3,10];case 9:if("channelClosed"===(d=o.sent()).message)return[2,D(oe.transferFile,e,r,n)];if((h=F(d.message,[c.Df.NotDirectory,c.Df.AlreadyExists,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(i),h===c.Df.AlreadyExists&&(h=c.Df.IsDirectory),h)return[2,{error:h}];throw d;case 10:return re(i),[2,{error:null}]}}))}));return function(r,n,t){return e.apply(this,arguments)}}(),oe={getStatus:function(){return j},onStatusChange:function(e){return $.push(e),function(){var r=$.indexOf(e);r>-1&&$.splice(r,1)}},watchDir:function(e,r){var n=!1,t=function(){n=!0;var r=O.get(e);r&&(r.listeners=r.listeners.filter((function(e){return e.dispose!==t})),0===r.listeners.length&&O.delete(e))};return oe.readDir(e).then((function(o){if(!n){if(o.error){var l=new Error(o.error);return l.code=o.error,r.onError(l),void t()}var s=O.get(e);s||(s={path:e,type:c.Tv.Directory,children:o.children,listeners:[]},O.set(e,s),b&&b.send({subscribeFile:{files:[{path:e}]}})),s.listeners.push((0,a.Z)((0,i.Z)({},r),{dispose:t})),r.onChange(o.children)}})).catch((function(e){t(),r.onError(e)})),t},watchFilePath:function(e,r){var n,t=function(e,n){if(0===n.length){var o=oe.watchFile(e,r);return function(){o()}}var i,a=n[0],l=!1,s=oe.watchDir(e,{onChange:function(r){var o=r.find((function(e){return e.filename===a}));if(!l&&o)return i=t("".concat(e,"/").concat(a),n.slice(1)),void(l=!0);l=!1},onMoveOrDelete:function(){null===i||void 0===i||i()},onError:function(){}});return function(){null===i||void 0===i||i(),s()}},o=e.split("/"),i=!1,a=oe.watchDir(".",{onChange:function(e){var r=e.find((function(e){return e.filename===o[0]}));if(!i&&r)return n=t(o[0],o.slice(1)),void(i=!0);i=!1},onError:function(){}});return function(){null===n||void 0===n||n(),a()}},writeFile:function(e,r){return(0,o.Z)((function(){var n,t,o,i,a,l;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return t="string"===typeof r?u.Z.from(r).toBuffer():r.toBuffer(),[4,X({write:{path:e,content:t}},{isMutative:!0})];case 1:if(o=s.sent(),a=null===(n=O.get((0,f.Il)(e)))||void 0===n?void 0:n.children.some((function(r){return r.filename===(0,f.UO)(e)})),i=V.has(e)||Z.has(e)||a?{eventType:c.kS.Modify,node:{path:e,type:c.Tv.File}}:{eventType:c.kS.Create,node:{path:e,type:c.Tv.File}},o.error){if((l=F(o.error,[c.Df.NotDirectory,c.Df.AlreadyExists,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(i),l===c.Df.AlreadyExists&&(l=c.Df.IsDirectory),!l)throw new Error(o.error);return[2,{error:l}]}return re(i),[2,{error:null}]}}))}))()},transferFile:function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(0,o.Z)((function(){var e;return(0,s.__generator)(this,(function(n){return e=te.apply(void 0,(0,l.Z)(r)),m(e),[2,e]}))}))()},readFile:function(e){var r=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{fromDisk:!1}).fromDisk;return(0,o.Z)((function(){var n,t,o,i;return(0,s.__generator)(this,(function(a){switch(a.label){case 0:if(!r){if((n=Z.get(e))&&n.otClient.getRawLocalContent()&&!n.otClient.isReconnecting)return[2,{content:u.Z.from(n.otClient.getRawLocalContent()),error:null}];if(t=V.get(e))return[2,{content:t.latestContent,error:null}]}return[4,X({read:{path:e}},{isMutative:!1})];case 1:if((o=a.sent()).error){if(!(i=F(o.error,[c.Df.NotFound,c.Df.IsDirectory])))throw new Error(o.error);return[2,{error:i}]}if(!o.file||!o.file.path||!o.file.content)throw new Error("Expected file");return[2,{content:u.Z.from(o.file.content),error:null}]}}))}))()},createDir:function(e){return(0,o.Z)((function(){var r,n,t;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return[4,X({mkdir:{path:e}},{isMutative:!0})];case 1:if(r=o.sent(),n={eventType:c.kS.Create,node:{path:e,type:c.Tv.Directory}},r.error){if((t=F(r.error,[c.Df.NotDirectory,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(n),!t)throw new Error(r.error);return[2,{error:t}]}return re(n),[2,{error:null}]}}))}))()},moveDir:function(e,r){return(0,o.Z)((function(){var n,t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,X({move:{oldPath:e,newPath:r}},{isMutative:!0})];case 1:if(n=i.sent(),t={eventType:c.kS.Move,node:{path:e,type:c.Tv.Directory},to:r},n.error){if((o=F(n.error,[c.Df.NotFound,c.Df.AlreadyExists,c.Df.NotDirectory,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(t),!o)throw new Error(n.error);return[2,{error:o}]}return re(t),[2,{error:null}]}}))}))()},moveFile:function(e,r){return(0,o.Z)((function(){var n,t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,X({move:{oldPath:e,newPath:r}},{isMutative:!0})];case 1:if(n=i.sent(),t={eventType:c.kS.Move,node:{path:e,type:c.Tv.File},to:r},n.error){if((o=F(n.error,[c.Df.NotFound,c.Df.AlreadyExists,c.Df.NotDirectory,c.Df.DiskQuotaExceeded]))===c.Df.DiskQuotaExceeded&&g(t),!o)throw new Error(n.error);return[2,{error:o}]}return re(t),[2,{error:null}]}}))}))()},copyFile:function(e,r){return(0,o.Z)((function(){var n;return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,oe.readFile(e)];case 1:return(n=t.sent()).error?[2,n]:[2,oe.writeFile(r,n.content)]}}))}))()},copyDirFromRemote:function(e,r,n){return(0,o.Z)((function(){var t,o,i,a,l,u,f,d,h,p,v,y,m;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return[4,this.deleteDir(e)];case 1:return s.sent(),[4,n.readDir(e)];case 2:return(t=s.sent()).error?[2,t]:[4,this.readDir(r)];case 3:return(o=s.sent()).error!==c.Df.NotFound?[3,5]:[4,this.createDir(e)];case 4:return s.sent(),[3,6];case 5:if(o.error===c.Df.NotDirectory)return[2,o];s.label=6;case 6:i=!0,a=!1,l=void 0,s.label=7;case 7:s.trys.push([7,15,16,17]),u=t.children[Symbol.iterator](),s.label=8;case 8:return(i=(f=u.next()).done)?[3,14]:(d=f.value,h="".concat(e,"/").concat(d.filename),d.type!==c.Tv.File?[3,11]:[4,n.readFile(h)]);case 9:return(p=s.sent()).error?[2,p]:[4,this.writeFile("".concat(r,"/").concat(d.filename),p.content)];case 10:return(v=s.sent()).error?[2,v]:[3,13];case 11:return d.type!==c.Tv.Directory?[3,13]:[4,this.copyDirFromRemote(h,"".concat(r,"/").concat(d.filename),n)];case 12:if((y=s.sent()).error)return[2,y];s.label=13;case 13:return i=!0,[3,8];case 14:return[3,17];case 15:return m=s.sent(),a=!0,l=m,[3,17];case 16:try{i||null==u.return||u.return()}finally{if(a)throw l}return[7];case 17:return[2,{error:null}]}}))})).apply(this)},copyFileFromRemote:function(e,r,n){return(0,o.Z)((function(){var t,o;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,n.readFile(e)];case 1:return(t=i.sent()).error?[2,t]:[4,this.writeFile(r,t.content)];case 2:return(o=i.sent()).error?[2,o]:[2,{error:null}]}}))})).apply(this)},deleteFile:function(e){return(0,o.Z)((function(){var r,n;return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,X({remove:{path:e}},{isMutative:!0})];case 1:if((r=t.sent()).error){if(!(n=F(r.error,[c.Df.NotFound])))throw new Error(r.error);return[2,{error:n}]}return re({eventType:c.kS.Delete,node:{path:e,type:c.Tv.File}}),[2,{error:null}]}}))}))()},deleteDir:function(e){return(0,o.Z)((function(){var r,n;return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,X({remove:{path:e}},{isMutative:!0})];case 1:if((r=t.sent()).error){if(!(n=F(r.error,[c.Df.NotFound])))throw new Error(r.error);return[2,{error:n}]}return re({eventType:c.kS.Delete,node:{path:e,type:c.Tv.Directory}}),[2,{error:null}]}}))}))()},readDir:function(e){return(0,o.Z)((function(){var r,n,t;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return[4,X({readdir:{path:e}},{isMutative:!1})];case 1:if((n=o.sent()).error){if(!(t=F(n.error,[c.Df.NotFound,c.Df.NotDirectory])))throw new Error(n.error);return[2,{error:t}]}if(!(null===(r=n.files)||void 0===r?void 0:r.files))throw new Error("Expected filesChannel");return[2,{children:n.files.files.map((function(e){if(!e.path)throw new Error("Expected path");return{filename:e.path,type:e.type===p.api.File.Type.DIRECTORY?c.Tv.Directory:c.Tv.File}})),error:null}]}}))}))()},stat:function(e){return(0,o.Z)((function(){var r;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return[4,X({stat:{path:e}},{isMutative:!1})];case 1:if((r=n.sent()).error)throw new Error(r.error);if(!r.statRes)throw new Error("expected stat result");return r.statRes.exists?r.statRes.type===p.api.File.Type.DIRECTORY?[2,{exists:!0,type:c.Tv.Directory,lastModified:new Date(1e3*r.statRes.modTime)}]:[2,{exists:!0,type:c.Tv.File,lastModified:new Date(1e3*r.statRes.modTime),byteLength:Number(r.statRes.size)}]:[2,{exists:!1}]}}))}))()},watchTextFile:function(e,r){var n=this,t=Z.get(e);if(t||(t={path:e,type:c.Tv.File,listeners:[],otClient:w(e)},Z.set(e,t)),!t)throw new Error("Expected watchedOtFile");var u=!1,f=!1,d=function(){},h=[],p=function(i){if(d(),!t)throw new Error("Expected watchedOtFile");var a=function(e){var n;return null===(n=r.onFlush)||void 0===n?void 0:n.call(r,e)};t.otClient.on("commitComplete",a);var y=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,c.KF.Dirty)};t.otClient.on("fileDirty",y);var m=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,c.KF.Clean)};t.otClient.on("fileClean",m);var C=function(){var e;return null===(e=r.onStatusChange)||void 0===e?void 0:e.call(r,c.KF.Syncing)};t.otClient.on("commitStart",C);var E=function(e){var n;return null===(n=r.onCursor)||void 0===n?void 0:n.call(r,e)};t.otClient.on("cursor",E);var D=function(e){var n;return null===(n=r.onRemoveCursor)||void 0===n?void 0:n.call(r,e)};t.otClient.on("removeCursor",D);var k=n,b=function(){var r=(0,o.Z)((function(r){var n,o,i,a,l,c,u,f,d,p,v;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!t)throw new Error("Expected watchedOtFile");return(n=t.otClient).destroy(),o=w(e),[4,new Promise((function(e,r){o.once("changes",(function(){return e()})),o.once("error",(function(e){return r(e)}))}))];case 1:if(s.sent(),i=n.getLocalContent(),a=o.getLocalContent(),l="local"===r?(0,A.F)(a,i):null,c="remote"===r?(0,A.F)(i,a):null,!t)throw new Error("Expected watchedOtFile");t.otClient=o,u=!0,f=!1,d=void 0;try{for(p=t.listeners[Symbol.iterator]();!(u=(v=p.next()).done);u=!0)(0,v.value.reregister)(c)}catch(m){f=!0,d=m}finally{try{u||null==p.return||p.return()}finally{if(f)throw d}}for(l&&o.writeChanges(l);h.length>0;){var y;null===(y=h.pop())||void 0===y||y({isDisposed:!1})}return[4,k.flush()];case 2:return s.sent(),[2]}}))}));return function(e){return r.apply(this,arguments)}}(),F=function(e){var n;return null===(n=r.onReconnectFail)||void 0===n?void 0:n.call(r,b,e)};t.otClient.on("promptUserReconnect",F),t.listeners[0].reregister===p&&t.otClient.on("promptUserReconnect",(function(){if(Z.has(e)){if(!t)throw new Error("Expected watchedOtFile");t.listeners.some((function(e){return e.onReconnectFail}))||b("remote")}}));var S=function(e,n){r.onError&&r.onError(e,n),v()};t.otClient.on("error",S);var x=function(n,t){if(n===c.Df.DiskQuotaExceeded&&g({eventType:c.kS.Modify,node:{path:e,type:c.Tv.File}}),r.onError){var o=new Error(t);o.code=n,r.onError(o)}v()};t.otClient.on("fsError",x);var T=function(e,n){if(!t)throw new Error("Expected watchedOtFile");var o=_.as.of(e,t.otClient.getLocalContent().length,"\n");t.otClient.writeChanges(o,n);var i=!0,a=!1,l=void 0;try{for(var s,u=t.listeners[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var f=s.value.onChange;f&&f!==r.onChange&&f({changes:o,changeSource:c.Fl.Local,version:t.otClient.version,latestContent:t.otClient.getLocalContent()})}}catch(d){a=!0,l=d}finally{try{i||null==u.return||u.return()}finally{if(a)throw l}}},O=function(){var e=(0,o.Z)((function(){return(0,s.__generator)(this,(function(e){return(null===t||void 0===t?void 0:t.otClient.isReconnecting)?[2,new Promise((function(e,r){t?h.push(e):r(new Error("Expected watchedOtFile"))}))]:[2,{isDisposed:u}]}))}));return function(){return e.apply(this,arguments)}}(),R=function(){for(;h.length>0;){var e;null===(e=h.pop())||void 0===e||e({isDisposed:!1})}};t.otClient.on("transparentReconnect",R);var P,L=function(){var e=(0,o.Z)((function(){var e,r,n,o,i,a=arguments;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:for(e=a.length,r=new Array(e),n=0;n<e;n++)r[n]=a[n];if(!t)throw new Error("Expected watchedOtFile");s.label=1;case 1:return s.trys.push([1,3,,4]),[4,O()];case 2:return s.sent().isDisposed?[2,{isDisposed:!0,result:null}]:[3,4];case 3:if(i=s.sent(),u)return[2,{isDisposed:!0,result:null}];throw i;case 4:return[4,(o=t.otClient).fetchChanges.apply(o,(0,l.Z)(r))];case 5:return[2,{isDisposed:!1,result:s.sent()}]}}))}));return function(){return e.apply(this,arguments)}}(),M=function(){var e=(0,o.Z)((function(){var e,r,n,o,i=arguments;return(0,s.__generator)(this,(function(a){switch(a.label){case 0:for(e=i.length,r=new Array(e),n=0;n<e;n++)r[n]=i[n];if(!t)throw new Error("Expected watchedOtFile");return[4,O()];case 1:if(a.sent().isDisposed)throw new Error("File was disposed");return[2,(o=t.otClient).transformSelection.apply(o,(0,l.Z)(r))]}}))}));return function(){return e.apply(this,arguments)}}(),I=function(e){if(!t)throw new Error("Expected watchedOtFile");t.otClient.updateCursors(e)};(-1!==t.otClient.version&&setTimeout((function(){var e;if(!f){if(!t)throw new Error("Expected watchedOtFile");f=!0,null===(e=r.onReady)||void 0===e||e.call(r,{initialContent:t.otClient.getLocalContent(),writeChange:T,updateSelections:I,fetchChanges:L,transformSelection:M,version:t.otClient.version})}})),i)&&(null===(P=r.onChange)||void 0===P||P.call(r,{changes:i,changeSource:c.Fl.Container,version:t.otClient.version,latestContent:t.otClient.getLocalContent()}));var N=function(e){var n,o;if(!t)throw new Error("Expected watchedOtFile");if(!f)return f=!0,void(null===(o=r.onReady)||void 0===o||o.call(r,{initialContent:t.otClient.getLocalContent(),writeChange:T,updateSelections:I,fetchChanges:L,transformSelection:M,version:t.otClient.version}));null===(n=r.onChange)||void 0===n||n.call(r,{changes:e,changeSource:c.Fl.Container,version:t.otClient.version,latestContent:t.otClient.getLocalContent()})};t.otClient.on("changes",N),d=function(){if(!t)throw new Error("Expected watchedOtFile");t.otClient.removeListener("commitComplete",a),t.otClient.removeListener("fileDirty",y),t.otClient.removeListener("fileClean",m),t.otClient.removeListener("commitStart",C),t.otClient.removeListener("error",S),t.otClient.removeListener("fsError",x),t.otClient.removeListener("changes",N),t.otClient.removeListener("cursor",E),t.otClient.removeListener("removeCursor",D),t.otClient.removeListener("promptUserReconnect",F),t.otClient.removeListener("transparentReconnect",R)},z()},v=function(){for(;h.length>0;){var r;null===(r=h.pop())||void 0===r||r({isDisposed:!0})}if(!u&&Z.has(e)){if(u=!0,f=!0,d(),!t)throw new Error("Expected watchedOtFile");t.listeners=t.listeners.filter((function(e){return e.dispose!==v})),0===t.listeners.length&&(t.otClient.destroy(),Z.delete(e))}};return t.listeners.push((0,a.Z)((0,i.Z)({},r),{dispose:v,reregister:p})),p(null),v},watchFile:function(e,r){var n=!1,t=function(){n=!0;var r=V.get(e);r&&(r.listeners=r.listeners.filter((function(e){return e.dispose!==t})),0===r.listeners.length&&V.delete(e))};return oe.readFile(e).then((function(o){if(!n){if(o.error){var l=new Error(o.error);return l.code=o.error,r.onError&&r.onError(l),void t()}var s=V.get(e);if(s||(s={path:e,type:c.Tv.File,listeners:[],latestContent:o.content},V.set(e,s),b&&b.send({subscribeFile:{files:[{path:e}]}})),!s)throw new Error("Expected watched file");s.listeners.push((0,a.Z)((0,i.Z)({},r),{dispose:t})),r.onChange(o.content)}})),t},listFiles:function(){return(0,o.Z)((function(){var e;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return x&&n.performance.now()-T<1e4?[2,x]:(S||(S=function(){return ne.apply(this,arguments)}(),T=n.performance.now()),[4,S]);case 1:return e=r.sent(),S=null,[2,e]}}))}))()},flush:function(e){var r=[],n=!0,t=!1,o=void 0;try{for(var i,a=Z.values()[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var s=i.value;null!==s.otClient.channel&&(s.otClient.isReconnecting||r.push(s.otClient.flush(e)))}}catch(c){t=!0,o=c}finally{try{n||null==a.return||a.return()}finally{if(t)throw o}}return Promise.all((0,l.Z)(r).concat((0,l.Z)(H)).map((function(e){return e.catch((function(){}))}))).then((function(){}))},persist:function(e){var r=W();return e&&e.skipDebounce&&W.flush(),r},getOTVersion:function(e){var r=Z.get(e);if(!r)throw new Error("No file with path ".concat(e," found."));return r.otClient.version},onDiskQuotaExceeded:function(e){return U.push(e),function(){U=U.filter((function(r){return r!==e}))}}};return oe}var U=n(2272),q=n(11969),Q={replsList:function(){return"dataLossRepls"},replFiles:function(e){return"dataLossReplFiles".concat(e)},latestOp:function(e,r){return"dataLossLatestOp--".concat(e,"--").concat(r)},latestFlushedOp:function(e,r){return"dataLossLatestFlushed--".concat(e,"--").concat(r)},latestOwnOp:function(e,r){return"dataLosslatestOwnOp--".concat(e,"--").concat(r)},opsSinceFlush:function(e,r){return"dataLossOpsSinceFlush--".concat(e,"--").concat(r)}};function W(e,r){var n={latestOp:null,latestFlushedOp:null,latestOwnOp:null},t=Object.keys(n),o=!0,i=!1,a=void 0;try{for(var l,s=t[Symbol.iterator]();!(o=(l=s.next()).done);o=!0){var c=l.value,u=q.Z.get(Q[c](e,r),"object");u&&(u&&"object"===typeof u&&"number"===typeof u.crc32&&"number"===typeof u.version&&(n[c]=u))}}catch(f){i=!0,a=f}finally{try{o||null==s.return||s.return()}finally{if(i)throw a}}return n}function j(){var e=q.Z.get(Q.replsList(),"array");return e||(e=[],q.Z.set(Q.replsList(),e)),e}function $(e){var r=q.Z.get(Q.replFiles(e),"array");return r||(r=[],q.Z.set(Q.replFiles(e),r)),r}function J(e){var r=$(e),n=!0,t=!1,o=void 0;try{for(var i,a=r[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var l=i.value;"string"===typeof l&&K(e,l)}}catch(c){t=!0,o=c}finally{try{n||null==a.return||a.return()}finally{if(t)throw o}}q.Z.remove(Q.replFiles(e));var s=j().filter((function(r){return r!==e}));q.Z.set(Q.replsList(),s)}function K(e,r){q.Z.remove(Q.latestOp(e,r)),q.Z.remove(Q.latestFlushedOp(e,r)),q.Z.remove(Q.latestOwnOp(e,r));var n=$(e).filter((function(e){return e!==r}));q.Z.set(Q.replFiles(e),n)}function Y(e){var r=e.replId,n=e.filePath;!function(e){var r=j();r.includes(e)||(r.length>20?(J(r[0]),r[0]=e):r.push(e),q.Z.set(Q.replsList(),r))}(r);var t=$(r);t.includes(n)||(t.length>20?(J(t[0]),t[0]=n):t.push(n),q.Z.set(Q.replFiles(r),t))}function z(e){var r=e.filePath,n=e.replId,t=e.opType,o=e.op;!function(e){var r=e.filePath,n=e.replId,t=e.opType,o=e.logger;if("latestFlushedOp"===t)q.Z.set(Q.opsSinceFlush(n,r),0);else{var i=q.Z.get(Q.opsSinceFlush(n,r),"number")||0;q.Z.set(Q.opsSinceFlush(n,r),i+1),150===i?o.info("ot client dataloss",{case:"flush_delay_small",opType:t,filePath:r}):1e3===i&&o.info("ot client dataloss",{case:"flush_delay_large",opType:t,filePath:r})}}({filePath:r,replId:n,opType:t,logger:e.logger}),q.Z.set(Q[t](n,r),o)}var G={};function H(e){return X.apply(this,arguments)}function X(){return X=(0,o.Z)((function(e){var r,n,t,i,a,l,c,u;return(0,s.__generator)(this,(function(f){return r=e.filePath,n=e.replId,t=e.serverVersion,i=e.serverContent,a=e.fetchOps,l=e.logger,G[r+n]||(G[r+n]=!0,c=W(n,r),u=C.str(i)>>>0,Object.keys(c).forEach(function(){var e=(0,o.Z)((function(e){var r,n,o,i;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(!(r=c[e]))return[2];if(t<r.version)return l.info("ot client dataloss",{opType:e,case:"server_forgot"}),[2];if(t===r.version)return u!==r.crc32&&l.info("ot client dataloss",{opType:e,case:"crc32_mismatch"}),[2];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,a(r.version,r.version)];case 2:return o=U.Z.apply(void 0,[s.sent(),1]),n=o[0],[3,4];case 3:return i=s.sent(),l.info("ot client dataloss",{opType:e,case:"error_fetching_op",originalError:String(i)}),[2];case 4:return n?(n.crc32!==r.crc32&&l.info("ot client dataloss",{opType:e,case:"crc32_mismatch"}),[2]):(l.info("ot client dataloss",{opType:e,case:"op_not_found"}),[2])}}))}));return function(r){return e.apply(this,arguments)}}())),[2]}))})),X.apply(this,arguments)}var ee=n(625);function re(e){var r=e.container,n=e.channelRequestPriority;return V({container:r,dataloss:t,track:ee.j,channelRequestPriority:n})}},22011:function(e,r,n){n.d(r,{Z:function(){return l}});var t=n(66091),o=n(57988),i=n(81962),a=n(91620).lW,l=function(){function e(r,n){if((0,t.Z)(this,e),this.asEncoding={},this.asBuffer=null,n&&"string"===typeof r)this.asEncoding[n]=r;else if(void 0===r||null===r)this.asBuffer=a.alloc(0);else if((0,i.Z)(r,a))this.asBuffer=r;else if("string"===typeof r)this.asEncoding.utf8=r;else if((0,i.Z)(r,ArrayBuffer))this.asBuffer=a.from(r);else{if((0,i.Z)(r,e))return r;(0,i.Z)(r,Uint8Array)?this.asBuffer=a.from(r):"object"!==typeof r||"object"!==typeof r.asEncoding||null===r.asEncoding||!(0,i.Z)(r.asBuffer,a)&&null!==r.asBuffer||(this.asBuffer=r.asBuffer||null,"string"===typeof r.asEncoding.base64&&(this.asEncoding={base64:r.asEncoding.base64}),"string"===typeof r.asEncoding.utf8&&(this.asEncoding={utf8:r.asEncoding.utf8}))}}var r=e.prototype;return r.toString=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8";if(void 0!==this.asEncoding[e])return this.asEncoding[e];var r=this.toBuffer(),n=r.toString(e);return this.asEncoding[e]=n,n},r.toJSON=function(){return{asEncoding:{base64:this.toString("base64")},asBuffer:null}},r.toBuffer=function(){if(this.asBuffer)return this.asBuffer;for(var e in this.asEncoding){var r=this.asEncoding[e];if("string"===typeof r){var n=a.from(r,e);return this.asBuffer=n,n}}return this.asBuffer=a.alloc(0),this.asBuffer},e.from=function(r,n){return new e(r,n)},e.isBuffer=function(r){return(0,i.Z)(r,e)},(0,o.Z)(e,[{key:"length",get:function(){return void 0!==this.asEncoding.utf8?this.asEncoding.utf8.length:this.toBuffer().length}}]),e}()},8082:function(e,r,n){n.d(r,{F:function(){return i}});var t=n(81362),o=n(14806);function i(e,r){var n=[],i=!0,a=!1,l=void 0;try{for(var s,c=(0,t.Hg)(e.toString(),r.toString())[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var u=s.value,f=u.fromA,d=u.fromB,h=u.toA,p=u.toB;f===h&&n.push({from:f,insert:r.slice(d,p)}),d===p&&n.push({from:f,to:h,insert:""}),f!==h&&d!==p&&n.push({from:f,to:h,insert:r.slice(d,p)})}}catch(v){a=!0,l=v}finally{try{i||null==c.return||c.return()}finally{if(a)throw l}}return o.as.of(n,e.length)}},20575:function(e,r,n){n.d(r,{C:function(){return o},h:function(){return i}});var t=/^(\.env$|\.npm$|\.npm\/|__pycache__|\.cache|\.breakpoints|\.git$|\.git\/|\.upm$|\.upm\/|node_modules$|node_modules\/|_test_runner)/;function o(e){return t.test(e)}var i=[".git",".upm",".cache","__pycache__","node_modules","venv"]},68282:function(e,r,n){n.d(r,{ed:function(){return a},f5:function(){return c},gR:function(){return o},mt:function(){return l},tT:function(){return u},ug:function(){return i}});var t=n(14806);function o(e){return e.map((function(e){return"object"===typeof e?{delete:e.d}:"number"===typeof e?{skip:e}:{insert:e}}))}function i(e){return e.map((function(e){if("delete"in e&&e.delete)return{d:e.delete};if("skip"in e&&e.skip)return e.skip;if("insert"in e&&"string"===typeof e.insert)return e.insert;throw new Error("Unexpected op type")}))}function a(e,r){var n=[],t=r,o=0,i=0,a=0,l=0,s=function(e){var n=e-i;if(e<i)throw new Error("expected changeset to be ordered");for(var t=i+a;t<i+n+a;t++){var o=r.charCodeAt(t);o>=55296&&o<=57343?(l++,t++):13===o&&10===r.charCodeAt(t+1)&&(a++,t++)}i+=n};return e.iterChanges((function(e,r,c,u,f){if(e>0){var d=i+a,h=d-l;s(e);var p=i+a,v=p-l;n.push(v-h),o+=p-d}if(e!==r){var y=i+a,m=y-l;s(r);var g=i+a,w=g-l;n.push({d:w-m});var C=g-y;t=t.slice(0,o)+t.slice(o+C)}if(f.length){var E=f.sliceString(0);n.push(E),t=t.slice(0,o)+E+t.slice(o),o+=E.length}})),{op:n,docAfter:t}}function l(e,r){var n,o=[],i=r,a=0,l=0,s=0,c=0,f=function(e){for(var n=l+s;n<l+e+s;n++){var t=r.charCodeAt(n);t>=55296&&t<=57343?(s++,n++):13===t&&10===r.charCodeAt(n+1)&&(c++,n++)}l+=e},d=!0,h=!1,p=void 0;try{for(var v,y=e[Symbol.iterator]();!(d=(v=y.next()).done);d=!0){var m=v.value;if("string"===typeof m){var g=m;i=i.slice(0,a)+g+i.slice(a),a+=g.length;var w=l+s;if(g.endsWith("\r")&&"\n"===r.slice(w,w+1)&&0===(g=g.slice(0,-1)).length)continue;var C=u(g),E=w-c;(null===n||void 0===n?void 0:n.to)===E?n.insert=n.insert?n.insert.append(C):C:(n={from:w-c,insert:C},o.push(n))}else if("number"===typeof m){var D=s;f(m),a+=m+(s-D)}else if("d"in m){var k=l+s,b=c;f(m.d);var F=l+s,S=F-k;i=i.slice(0,a)+i.slice(a+S);var _=k-b,x=F-c;if("\r\n"===r.slice(k-1,k+1)&&(x-=1)-(_+=1)<=0)continue;(null===n||void 0===n?void 0:n.to)===_?n.to=x:(n={from:_,to:x},o.push(n))}}}catch(O){h=!0,p=O}finally{try{d||null==y.return||y.return()}finally{if(h)throw p}}if(l+s!==r.length){var T=r.slice(l+s);c+=T.split("\r\n").length-1}return{changes:t.as.of(o,r.length-c),docAfter:i}}var s=/\r\n?|\n/;function c(e){return e.replaceAll("\r\n","\n").replaceAll("\r","\n")}function u(e){return t.xv.of(e.split(s))}}}]);
//# sourceMappingURL=593-ec06b5cc31b2fcc6.js.map